<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IndiaLearn ‚Äì Smart School App (Class 1‚Äì12)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Simple Google Font for nicer look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #ffecd2, #fcb69f);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    #app {
      background: #ffffffee;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      max-width: 1100px;
      width: 100%;
      padding: 16px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px 4px;
      border-bottom: 1px dashed rgba(0,0,0,0.08);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-badge {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb347, #ffcc33);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    }

    .logo-text-main {
      font-size: 20px;
      font-weight: 700;
      color: #ff7043;
    }

    .logo-text-sub {
      font-size: 11px;
      color: #777;
      line-height: 1.2;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
      justify-content: flex-end;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: #fff7e6;
      color: #ff7043;
      font-weight: 500;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.6fr);
      gap: 12px;
    }

    @media (max-width: 860px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.emoji {
      font-size: 18px;
    }

    .card-subtitle {
      font-size: 11px;
      color: #777;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #e3f2fd;
      color: #1976d2;
      font-weight: 600;
    }

    .section-body {
      font-size: 12px;
      color: #555;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .welcome-banner {
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(135deg, #ff9a9e, #fecfef);
      color: #4a148c;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .welcome-title {
      font-size: 16px;
      font-weight: 700;
    }

    .welcome-sub {
      font-size: 11px;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      font-size: 10px;
    }

    .badge {
      padding: 2px 7px;
      border-radius: 999px;
      background: #ffffffcc;
      color: #4a148c;
      font-weight: 600;
    }

    .grid {
      display: grid;
      gap: 6px;
    }

    .grid-classes {
      grid-template-columns: repeat(6, minmax(0, 1fr));
    }

    .grid-subjects {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    @media (max-width: 600px) {
      .grid-classes {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      .grid-subjects {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .btn {
      border: none;
      outline: none;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 999px;
      background: #f5f5f5;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease;
      text-align: center;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      background: #fffaf0;
    }

    .btn.selected {
      background: linear-gradient(135deg, #ff9800, #ffb74d);
      color: #fff;
      box-shadow: 0 3px 8px rgba(255,152,0,0.4);
    }

    .btn-primary {
      background: linear-gradient(135deg, #42a5f5, #5c6bc0);
      color: #fff;
      border-radius: 999px;
      font-size: 12px;
      padding: 6px 14px;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 0;
      font-size: 16px;
    }

    .btn-icon.active {
      background: linear-gradient(135deg, #ef5350, #f06292);
      color: #fff;
    }

    .hint {
      font-size: 11px;
      color: #888;
    }

    .inline-info {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      align-items: center;
      color: #666;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ff9800;
    }

    .syllabus-list,
    .quiz-question,
    .quiz-options,
    .ai-output {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .syllabus-tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .syllabus-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .skill-chip {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 6px 8px;
      font-size: 12px;
      resize: vertical;
      outline: none;
    }

    textarea:focus {
      border-color: #42a5f5;
      box-shadow: 0 0 0 2px rgba(66,165,245,0.15);
    }

    .progress-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
    }

    .progress-pill {
      padding: 3px 8px;
      border-radius: 999px;
      background: #f1f8e9;
      color: #558b2f;
      font-weight: 600;
    }

    .ai-output-box {
      border-radius: 10px;
      border: 1px dashed #e0e0e0;
      padding: 6px 8px;
      background: #fafafa;
      max-height: 180px;
      overflow-y: auto;
    }

    .small-label {
      font-size: 10px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pill-soft {
      padding: 2px 8px;
      border-radius: 999px;
      background: #fff3e0;
      color: #ef6c00;
      font-size: 10px;
      font-weight: 600;
    }

    .row-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.06), transparent);
      margin: 4px 0 2px;
    }

    .quiz-options label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 999px;
      background: #f9fbe7;
      cursor: pointer;
      border: 1px solid transparent;
      transition: border 0.08s ease, background 0.08s ease;
    }

    .quiz-options input[type="radio"] {
      accent-color: #ff9800;
      cursor: pointer;
    }

    .quiz-options label:hover {
      border-color: #ffb74d;
      background: #fffde7;
    }

    .status-text {
      font-size: 11px;
      color: #888;
    }

    footer {
      margin-top: 6px;
      font-size: 10px;
      color: #999;
      text-align: right;
    }

    /* NCERT TEXTBOOK CARD */
    .ncert-cover {
      border-radius: 10px;
      background: linear-gradient(135deg, #81c784, #a5d6a7);
      padding: 8px;
      color: #1b5e20;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ncert-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .ncert-chapters {
      margin-top: 4px;
      padding-left: 16px;
      font-size: 11px;
    }

    /* DEBUG OVERLAY */

    #debugToggle {
      position: fixed;
      right: 8px;
      bottom: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #212121ee;
      color: #ffeb3b;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      z-index: 9999;
      user-select: none;
    }

    #debugPanel {
      position: fixed;
      right: 8px;
      bottom: 48px;
      width: min(380px, 90vw);
      height: 40vh;
      background: #1e1e1ef0;
      color: #e0e0e0;
      border-radius: 12px 12px 0 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      display: none;
      flex-direction: column;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }

    #debugPanelHeader {
      padding: 4px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    #debugPanelHeader span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #debugPanelHeader button {
      background: transparent;
      border: none;
      color: #f5f5f5;
      font-size: 14px;
      cursor: pointer;
    }

    #debugLog {
      flex: 1;
      padding: 4px 8px;
      font-family: "Fira Code", "Consolas", monospace;
      font-size: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    #debugPanelFooter {
      padding: 2px 8px 4px;
      border-top: 1px solid rgba(255,255,255,0.12);
      font-size: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #debugStatusDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #66bb6a;
      box-shadow: 0 0 8px #66bb6a;
    }

    .debug-tag {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      font-size: 9px;
      opacity: 0.8;
    }

    /* QUIZ HINTS + EXPLANATION */
    .hint-box {
      margin-top: 4px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #fff3e0;
      font-size: 11px;
      color: #e65100;
    }

    .explanation-box {
      margin-top: 4px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #e3f2fd;
      font-size: 11px;
      color: #0d47a1;
    }

    .quiz-meta {
      font-size: 11px;
      color: #666;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill-mini {
      padding: 2px 6px;
      border-radius: 999px;
      background: #ede7f6;
      font-size: 10px;
      color: #5e35b1;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="logo">
        <div class="logo-badge">IL</div>
        <div>
          <div class="logo-text-main">IndiaLearn</div>
          <div class="logo-text-sub">
            Class 1‚Äì12 ‚Ä¢ CBSE / State ‚Ä¢ Future-Ready Skills
          </div>
        </div>
      </div>
      <div>
        <div class="chip-row">
          <div class="chip">üß† AI Tutor (with Voice)</div>
          <div class="chip">üì± Mobile First</div>
          <div class="chip">üáÆüá≥ NCERT-Aligned</div>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT SIDE: Welcome, Class & Subject, Quiz -->
      <section class="card" id="welcomeSection">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">üéì</span>
              <span>Welcome, Super Student!</span>
            </div>
            <div class="card-subtitle">Choose your class & subject to start learning.</div>
          </div>
          <div class="pill">Step 1 ‚Üí 2 ‚Üí 3</div>
        </div>
        <div class="section-body">
          <div class="welcome-banner">
            <div class="welcome-title">One App for School + Future Skills üöÄ</div>
            <div class="welcome-sub">
              Learn Maths, Science, English & Hindi along with
              <strong>AI, coding, money skills, climate, mental health & safety</strong>.
            </div>
            <div class="badge-row">
              <div class="badge">üìö NCERT Textbooks (PDF)</div>
              <div class="badge">üßÆ 50+ Quiz Questions</div>
              <div class="badge">ü§ñ AI Study Partner (Voice)</div>
            </div>
          </div>

          <!-- Class Selection -->
          <div>
            <div class="row-between">
              <div class="card-title" style="font-size:13px;">
                <span class="emoji">üè´</span>
                <span>Select Your Class</span>
              </div>
              <div class="hint">Tap one: 1‚Äì12</div>
            </div>
            <div id="classButtons" class="grid grid-classes" aria-label="Class selection buttons">
              <!-- Filled by JS -->
            </div>
          </div>

          <!-- Subject Selection -->
          <div>
            <div class="row-between">
              <div class="card-title" style="font-size:13px;">
                <span class="emoji">üìò</span>
                <span>Select Subject</span>
              </div>
              <div class="hint">Core subjects (+ future skills)</div>
            </div>
            <div id="subjectButtons" class="grid grid-subjects" aria-label="Subject selection buttons">
              <!-- Filled by JS -->
            </div>
          </div>

          <div class="inline-info">
            <div class="dot"></div>
            <span id="currentSelectionLabel">No class/subject selected.</span>
          </div>

          <div class="divider"></div>

          <!-- Quiz Area -->
          <div id="quizSection">
            <div class="card-header" style="padding:0; margin-bottom:2px;">
              <div class="card-title" style="font-size:13px;">
                <span class="emoji">üßÆ</span>
                <span>Enhanced Quiz ‚Äì 50+ Questions with Hints</span>
              </div>
              <div class="pill-soft">Auto-generated per class & subject</div>
            </div>

            <div class="section-body">
              <div class="hint">
                Quiz adapts to your <strong>selected class & subject</strong>. For now, Maths has the richest question bank.
              </div>
              <div id="quizContent">
                <button class="btn-primary" id="startQuizBtn">‚ñ∂ Start Quiz</button>
              </div>
              <div class="quiz-meta">
                <span id="quizStatus"></span>
                <span id="quizHintsStatus" class="pill-mini">Hints left: 0</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT SIDE: Syllabus, NCERT, AI Tutor, Progress -->
      <section class="card">
        <!-- Syllabus -->
        <div id="syllabusSection">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="emoji">üìö</span>
                <span>Smart Syllabus + Future-Proof Skills</span>
              </div>
              <div class="card-subtitle">
                Based on your class & subject, plus essential <strong>life skills</strong>.
              </div>
            </div>
            <div class="pill">Auto-generated</div>
          </div>
          <div class="section-body">
            <div class="small-label">SYLLABUS SNAPSHOT</div>
            <div id="syllabusContent" class="syllabus-list">
              Select a class & subject to see your smart syllabus here.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- NCERT TEXTBOOK INTEGRATION -->
        <div id="ncertSection">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="emoji">üìó</span>
                <span>NCERT Textbooks (Official PDF)</span>
              </div>
              <div class="card-subtitle">
                Direct access to NCERT‚Äôs official textbook PDF page for Class 1‚Äì12.
              </div>
            </div>
            <div class="pill-soft">Official: ncert.nic.in</div>
          </div>
          <div class="section-body">
            <div class="ncert-cover" id="ncertCover">
              <div id="ncertTitle"><strong>NCERT Textbook</strong> ‚Äì Select class & subject above.</div>
              <div id="ncertSubTitle" style="font-size:11px;">
                Once selected, we‚Äôll show a sample chapter list and quick links to NCERT‚Äôs official PDF page.
              </div>
            </div>
            <div class="ncert-actions">
              <a class="btn" id="ncertOpenBtn" href="https://ncert.nic.in/textbook.php" target="_blank" rel="noopener noreferrer">
                üåê Open NCERT Textbook Page
              </a>
              <a class="btn" id="ncertDownloadBtn" href="https://ncert.nic.in/textbook.php" target="_blank" rel="noopener noreferrer">
                ‚¨á Download / Read PDF (NCERT Site)
              </a>
            </div>
            <div>
              <div class="small-label">SAMPLE CHAPTER LIST (NOT OFFICIAL)</div>
              <ul class="ncert-chapters" id="ncertChapters">
                <li>Select a class & subject to view an example chapter breakdown aligned with NCERT style.</li>
              </ul>
              <div class="hint">
                Exact chapter names and PDFs are always taken from the official NCERT website only. This app just helps you reach the right place quickly.
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- AI Tutor -->
        <div id="aiSection">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="emoji">ü§ñ</span>
                <span>AI Study Partner (Hugging Face + Voice)</span>
              </div>
              <div class="card-subtitle">
                Ask doubts, get explanations or new practice questions ‚Äì now with voice input.
              </div>
            </div>
            <div class="pill-soft">Online ‚Ä¢ Text + Voice</div>
          </div>
          <div class="section-body">
            <label for="aiQuestion" class="small-label">YOUR QUESTION / TOPIC</label>
            <textarea id="aiQuestion" placeholder="Example: 'Explain place value for Class 3' or 'Give 5 word problems on addition for Class 1'"></textarea>

            <div class="row-between">
              <div class="hint">
                Use the üé§ button to speak your doubt (supported browsers only). AI answers in <strong>simple, exam-friendly steps</strong>.
              </div>
              <div style="display:flex; gap:6px; align-items:center;">
                <button class="btn btn-icon" id="voiceInputBtn" title="Use voice input">üé§</button>
                <button class="btn-primary" id="askAiBtn">‚ö° Ask AI</button>
              </div>
            </div>

            <div class="ai-output">
              <div class="small-label">AI RESPONSE</div>
              <div id="aiStatus" class="status-text">AI not used yet.</div>
              <div class="ai-output-box" id="aiAnswerBox">
                Your AI explanation will appear here.
              </div>
            </div>
            <div class="hint" id="voiceSupportHint"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Progress -->
        <div id="progressSection">
          <div class="card-header">
            <div class="card-title">
              <span class="emoji">üìà</span>
              <span>Your Learning Progress (This Session)</span>
            </div>
            <div class="pill">Local only</div>
          </div>
          <div class="section-body">
            <div class="progress-row" id="progressRow">
              <div class="progress-pill" id="progressQuizzes">üßÆ Quizzes taken: 0</div>
              <div class="progress-pill" id="progressCorrect">‚úÖ Correct answers: 0</div>
              <div class="progress-pill" id="progressAi">ü§ñ AI questions: 0</div>
            </div>
            <div class="hint">
              This data is stored <strong>only in this browser tab</strong>. Closing the tab will reset it.
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      v1.1 ‚Ä¢ Frontend-only demo ‚Ä¢ NCERT link helper ‚Ä¢ Enhanced Quiz ‚Ä¢ Hugging Face AI with Voice ‚Ä¢ Visual debug console.
    </footer>
  </div>

  <!-- DEBUG OVERLAY -->
  <div id="debugToggle" title="Toggle debug console">üêû</div>
  <div id="debugPanel">
    <div id="debugPanelHeader">
      <span>
        <strong>Visual Debugger</strong>
        <span style="opacity:0.8;">‚Ä¢ UI & API logs</span>
      </span>
      <button id="debugCloseBtn" title="Close debug panel">‚úï</button>
    </div>
    <pre id="debugLog"></pre>
    <div id="debugPanelFooter">
      <div style="display:flex; align-items:center; gap:6px;">
        <div id="debugStatusDot"></div>
        <span style="opacity:0.8;">LIVE</span>
      </div>
      <div class="debug-tag">UI ‚Ä¢ Quiz ‚Ä¢ NCERT ‚Ä¢ HF API ‚Ä¢ Voice</div>
    </div>
  </div>

  <script>
    /************************************************************
     *  HUGGING FACE FRONTEND CONFIG (SAMPLE DEMO SPACE)
     ************************************************************/
    // ‚ùó You can replace this later with your own Space or backend.
    // Example format (Gradio Space): POST to /api/predict with body { data: [prompt] }
    const HF_BACKEND_URL = "https://yuntian-deng-llama-2-7b-chat.hf.space/api/predict";

    /************************************************************
     *  GLOBAL STATE
     ************************************************************/
    const state = {
      selectedClass: null,
      selectedSubject: null,
      quizIndex: 0,
      quizQuestions: [],
      quizScore: 0,
      quizHintsUsed: 0,
      quizHintsPerQuestion: 3,
      progress: {
        quizzesTaken: 0,
        correctAnswers: 0,
        aiQueries: 0,
      },
      voice: {
        recognition: null,
        listening: false
      }
    };

    /************************************************************
     *  VISUAL DEBUGGER
     ************************************************************/
    const debugLogEl = document.getElementById("debugLog");
    let debugPanelVisible = false;
    const debugPanel = document.getElementById("debugPanel");
    const debugToggle = document.getElementById("debugToggle");
    const debugCloseBtn = document.getElementById("debugCloseBtn");

    function debugLog(message, extra) {
      const timestamp = new Date().toISOString().split("T")[1].replace("Z", "");
      let line = "[" + timestamp + "] " + message;
      if (extra !== undefined) {
        try {
          line += " ‚Üí " + JSON.stringify(extra);
        } catch (e) {
          line += " ‚Üí [unserializable extra]";
        }
      }
      if (debugLogEl) {
        debugLogEl.textContent += line + "\n";
        debugLogEl.scrollTop = debugLogEl.scrollHeight;
      }
      console.log("[DEBUG]", message, extra || "");
    }

    function toggleDebugPanel(forceState) {
      debugPanelVisible = typeof forceState === "boolean" ? forceState : !debugPanelVisible;
      if (debugPanelVisible) {
        debugPanel.style.display = "flex";
        debugLog("Debug panel opened");
      } else {
        debugPanel.style.display = "none";
        debugLog("Debug panel closed");
      }
    }

    debugToggle.addEventListener("click", () => toggleDebugPanel());
    debugCloseBtn.addEventListener("click", () => toggleDebugPanel(false));

    window.addEventListener("error", (event) => {
      debugLog("Window error captured", {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno
      });
    });

    /************************************************************
     *  APP INIT ‚Äì CLASS & SUBJECT BUTTONS
     ************************************************************/
    const classes = Array.from({ length: 12 }, (_, i) => i + 1);

    const subjects = [
      { id: "maths", label: "Maths", emoji: "üßÆ" },
      { id: "science", label: "Science", emoji: "üî¨" },
      { id: "english", label: "English", emoji: "üìñ" },
      { id: "hindi", label: "Hindi", emoji: "üìù" }
    ];

    function buildClassButtons() {
      const container = document.getElementById("classButtons");
      if (!container) {
        debugLog("Class buttons container NOT found", { id: "classButtons" });
        return;
      }
      container.innerHTML = "";
      classes.forEach((cls) => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Class " + cls;
        btn.dataset.value = cls;
        btn.addEventListener("click", () => handleClassClick(cls, btn));
        container.appendChild(btn);
      });
      debugLog("Class buttons built", { count: classes.length });
    }

    function buildSubjectButtons() {
      const container = document.getElementById("subjectButtons");
      if (!container) {
        debugLog("Subject buttons container NOT found", { id: "subjectButtons" });
        return;
      }
      container.innerHTML = "";
      subjects.forEach((sub) => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = sub.emoji + " " + sub.label;
        btn.dataset.value = sub.id;
        btn.addEventListener("click", () => handleSubjectClick(sub.id, btn));
        container.appendChild(btn);
      });
      debugLog("Subject buttons built", { count: subjects.length });
    }

    function handleClassClick(cls, clickedBtn) {
      state.selectedClass = cls;
      debugLog("Class selected", { class: cls });

      document.querySelectorAll("#classButtons .btn").forEach((btn) => {
        btn.classList.toggle("selected", btn === clickedBtn);
      });

      updateSelectionLabel();
      buildClassSyllabus();
      updateNcertSection();
      resetQuizStateForNewSelection();
    }

    function handleSubjectClick(subjectId, clickedBtn) {
      state.selectedSubject = subjectId;
      debugLog("Subject selected", { subject: subjectId });

      document.querySelectorAll("#subjectButtons .btn").forEach((btn) => {
        btn.classList.toggle("selected", btn === clickedBtn);
      });

      updateSelectionLabel();
      buildClassSyllabus();
      updateNcertSection();
      resetQuizStateForNewSelection();
    }

    function updateSelectionLabel() {
      const el = document.getElementById("currentSelectionLabel");
      if (!el) return;

      if (!state.selectedClass && !state.selectedSubject) {
        el.textContent = "No class/subject selected.";
        return;
      }

      const subjectObj = subjects.find((s) => s.id === state.selectedSubject);
      const subjectLabel = subjectObj ? subjectObj.label : "No subject";
      const classLabel = state.selectedClass ? "Class " + state.selectedClass : "No class";
      el.textContent = classLabel + " ‚Ä¢ " + subjectLabel;
    }

    /************************************************************
     *  FUTURE-PROOF SYLLABUS BUILDER
     ************************************************************/
    function buildClassSyllabus() {
      const container = document.getElementById("syllabusContent");
      if (!container) return;

      const cls = state.selectedClass;
      const subjectId = state.selectedSubject;
      if (!cls || !subjectId) {
        container.innerHTML = "Please select a <strong>class</strong> and a <strong>subject</strong> to view syllabus.";
        debugLog("Syllabus not built ‚Äì missing selection", { class: cls, subject: subjectId });
        return;
      }

      const baseTopicsBySubject = {
        maths: [
          "Numbers and counting with place value (difficulty increases with class)",
          "Operations: addition, subtraction, multiplication, division & word problems",
          "Fractions, decimals, percentages (from middle school onwards)",
          "Geometry basics: shapes, angles, perimeter, area",
          "Data handling: pictographs, bar graphs, statistics (mean, median, mode)"
        ],
        science: [
          "Living and non-living things; plant & animal life",
          "Human body, health & hygiene; food & digestion",
          "Matter, water, air, energy and simple physics concepts",
          "Environment, resources and sustainability",
          "Simple experiments, observation & scientific method"
        ],
        english: [
          "Reading comprehension with stories and factual passages",
          "Grammar: parts of speech, tenses, punctuation",
          "Vocabulary building and word usage in context",
          "Writing: paragraphs, letters, notices, essays & emails",
          "Speaking and listening activities"
        ],
        hindi: [
          "‡§µ‡§∞‡•ç‡§£‡§Æ‡§æ‡§≤‡§æ, ‡§â‡§ö‡•ç‡§ö‡§æ‡§∞‡§£ ‡§î‡§∞ ‡§∂‡§¨‡•ç‡§¶ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ (lower classes)",
          "‡§™‡•à‡§∞‡§æ ‡§î‡§∞ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂ ‡§™‡§†‡§® ‡§µ ‡§¨‡•ã‡§ß",
          "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£: ‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ, ‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ, ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ, ‡§µ‡§ø‡§∂‡•á‡§∑‡§£, ‡§ï‡§æ‡§≤ ‡§á‡§§‡•ç‡§Ø‡§æ‡§¶‡§ø",
          "‡§≤‡•á‡§ñ‡§®: ‡§Ö‡§®‡•Å‡§ö‡•ç‡§õ‡•á‡§¶, ‡§™‡§§‡•ç‡§∞, ‡§®‡§ø‡§¨‡§Ç‡§ß, ‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§≤‡•á‡§ñ‡§®",
          "‡§ï‡§µ‡§ø‡§§‡§æ ‡§î‡§∞ ‡§∏‡§æ‡§π‡§ø‡§§‡•ç‡§Ø‡§ø‡§ï ‡§∞‡§ö‡§®‡§æ‡§ì‡§Ç ‡§∏‡•á ‡§™‡§∞‡§ø‡§ö‡§Ø"
        ]
      };

      const subjectName = subjects.find((s) => s.id === subjectId)?.label || "Subject";
      const baseTopics = baseTopicsBySubject[subjectId] || ["Core textbook topics as per board syllabus."];

      const futureSkillsUniversal = [
        { tag: "üåç Climate & Sustainability", description: "Understanding pollution, water saving, recycling, clean energy and how daily actions affect Earth." },
        { tag: "üß† Mental Health & Well-being", description: "Recognising feelings, stress basics, kindness, gratitude, simple breathing and calm-down techniques." },
        { tag: "üîê Digital Safety & Cyber Hygiene", description: "Safe passwords, not sharing OTP, avoiding strangers online, basic cyberbullying awareness." },
        { tag: "üß† Critical Thinking & Problem Solving", description: "Asking 'why', comparing information, spotting patterns, solving puzzles and real-life problems." },
        { tag: "üí∞ Financial Literacy & Money Basics", description: "Saving vs spending, needs vs wants, simple budgeting and importance of not taking random loans." }
      ];

      const codingAndAiSkills = [];
      if (cls <= 5) {
        codingAndAiSkills.push(
          { tag: "üêç Coding Foundations (Blocks / Logic)", description: "Understanding sequences, patterns and logic through games and visual coding." },
          { tag: "ü§ñ AI Awareness (Very Basic)", description: "Knowing that some apps are 'smart', ask questions, and must be used respectfully." }
        );
      } else if (cls <= 8) {
        codingAndAiSkills.push(
          { tag: "üêç Python Basics", description: "Print, variables, basic maths, if-else, loops with small, fun programs." },
          { tag: "üåê JavaScript & Web", description: "Understanding how web pages work; writing simple scripts for interaction." },
          { tag: "üìä Data Literacy", description: "Reading simple charts and tables; understanding averages and trends." },
          { tag: "ü§ñ AI & Chatbots", description: "Using AI responsibly for homework help; understanding bias and limitations." }
        );
      } else {
        codingAndAiSkills.push(
          { tag: "üêç Python (Intermediate)", description: "Functions, lists, dictionaries, simple projects like calculators or quiz apps." },
          { tag: "üåê JavaScript & Frontend", description: "DOM basics, events, simple interactive web pages." },
          { tag: "üìä Data Analysis & AI Literacy", description: "Collecting data, using spreadsheets, basic charts, intro to ML ideas." },
          { tag: "üí∏ Entrepreneurship & Side Projects", description: "Project planning, digital products, ethical earning using skills + AI." }
        );
      }

      let html = "";
      html += `<div><strong>${"Class " + cls} ‚Ä¢ ${subjectName}</strong></div>`;
      html += `<div class="syllabus-tag-row">`;
      html += `<div class="syllabus-tag">üìñ Textbook + NCERT/Board aligned</div>`;
      html += `<div class="syllabus-tag">üß© Concept + Application</div>`;
      html += `<div class="syllabus-tag">üáÆüá≥ India context examples</div>`;
      html += `</div>`;

      html += `<ul style="margin-top:6px; padding-left:18px;">`;
      baseTopics.forEach((topic) => {
        html += `<li>${topic}</li>`;
      });
      html += `</ul>`;

      html += `<div style="margin-top:6px; font-size:11px; color:#666;"><strong>Future-Proof Life Skills</strong> (taught through stories, discussions and activities):</div>`;
      html += `<ul style="margin-top:4px; padding-left:18px;">`;
      futureSkillsUniversal.forEach((skill) => {
        html += `<li><strong>${skill.tag}:</strong> ${skill.description}</li>`;
      });
      html += `</ul>`;

      html += `<div style="margin-top:6px; font-size:11px; color:#666;"><strong>Coding, AI & Data Skills</strong> (age-appropriate, gradual):</div>`;
      html += `<ul style="margin-top:4px; padding-left:18px;">`;
      codingAndAiSkills.forEach((skill) => {
        html += `<li><strong>${skill.tag}:</strong> ${skill.description}</li>`;
      });
      html += `</ul>`;

      html += `<div class="syllabus-tag-row" style="margin-top:4px;">`;
      html += `<div class="skill-chip">üß† Critical thinking in every subject</div>`;
      html += `<div class="skill-chip">üë• Group work & projects</div>`;
      html += `<div class="skill-chip">üó£Ô∏è Speaking & presentation practice</div>`;
      html += `</div>`;

      container.innerHTML = html;
      debugLog("Syllabus built", { class: cls, subject: subjectId });
    }

    /************************************************************
     *  NCERT TEXTBOOK SECTION ‚Äì LINK HELPER + SAMPLE CHAPTERS
     ************************************************************/
    function updateNcertSection() {
      const cls = state.selectedClass;
      const subjectId = state.selectedSubject;
      const titleEl = document.getElementById("ncertTitle");
      const subtitleEl = document.getElementById("ncertSubTitle");
      const chapterListEl = document.getElementById("ncertChapters");
      const openBtn = document.getElementById("ncertOpenBtn");
      const downloadBtn = document.getElementById("ncertDownloadBtn");

      if (!titleEl || !subtitleEl || !chapterListEl || !openBtn || !downloadBtn) {
        debugLog("NCERT elements missing");
        return;
      }

      const subjectObj = subjects.find((s) => s.id === subjectId);
      const subjectLabel = subjectObj ? subjectObj.label : "Subject";

      if (!cls || !subjectId) {
        titleEl.innerHTML = "<strong>NCERT Textbook</strong> ‚Äì Select class & subject above.";
        subtitleEl.textContent = "Once selected, we‚Äôll show a sample chapter list and quick links to NCERT‚Äôs official PDF page.";
        chapterListEl.innerHTML = "<li>Select a class & subject to view an example chapter breakdown aligned with NCERT style.</li>";
        openBtn.href = "https://ncert.nic.in/textbook.php";
        downloadBtn.href = "https://ncert.nic.in/textbook.php";
        debugLog("NCERT section reset ‚Äì no selection");
        return;
      }

      titleEl.innerHTML = `<strong>Class ${cls} ‚Ä¢ ${subjectLabel}</strong> ‚Äì NCERT Textbook Helper`;
      subtitleEl.textContent = "Use the buttons below to open NCERT‚Äôs official PDF page. Chapter titles below are sample placeholders, not the official names.";

      // Simple generic chapter outline to avoid hallucinating exact titles
      const sampleChapterCount = Math.min(12, 5 + cls); // 6‚Äì17 chapters based on class
      const sampleChapters = [];
      for (let i = 1; i <= sampleChapterCount; i++) {
        sampleChapters.push(`Chapter ${i} ‚Äì Topic ${i} (as per NCERT book for this class & subject)`);
      }

      chapterListEl.innerHTML = sampleChapters.map((c) => `<li>${c}</li>`).join("");

      // Link to NCERT textbook page (official hub)
      const ncertBase = "https://ncert.nic.in/textbook.php";
      openBtn.href = ncertBase;
      downloadBtn.href = ncertBase;

      debugLog("NCERT section updated", { class: cls, subject: subjectId });
    }

    /************************************************************
     *  ENHANCED QUIZ SYSTEM
     *  - 50+ questions for Maths via generator
     *  - Hints (3 per question)
     *  - Explanation for each answer
     ************************************************************/
    function resetQuizStateForNewSelection() {
      state.quizIndex = 0;
      state.quizQuestions = [];
      state.quizScore = 0;
      state.quizHintsUsed = 0;
      const quizContent = document.getElementById("quizContent");
      const quizStatus = document.getElementById("quizStatus");
      const hintsStatus = document.getElementById("quizHintsStatus");
      if (quizContent) {
        quizContent.innerHTML = `<button class="btn-primary" id="startQuizBtn">‚ñ∂ Start Quiz</button>`;
        const btn = document.getElementById("startQuizBtn");
        if (btn) btn.addEventListener("click", startQuiz);
      }
      if (quizStatus) quizStatus.textContent = "";
      if (hintsStatus) hintsStatus.textContent = "Hints left: 0";
      debugLog("Quiz reset after selection change");
    }

    function generateMathQuestion(difficulty) {
      // difficulty ~ class; generate simple arithmetic
      const ops = ["+", "-", "√ó"];
      if (difficulty >= 6) ops.push("√∑");

      const op = ops[Math.floor(Math.random() * ops.length)];

      let a, b, correct;
      if (op === "+") {
        a = randomInt(1, 10 + difficulty * 3);
        b = randomInt(1, 10 + difficulty * 3);
        correct = a + b;
      } else if (op === "-") {
        a = randomInt(1, 10 + difficulty * 3);
        b = randomInt(1, a); // ensure non-negative
        correct = a - b;
      } else if (op === "√ó") {
        a = randomInt(1, 5 + Math.floor(difficulty / 2));
        b = randomInt(1, 5 + Math.floor(difficulty / 2));
        correct = a * b;
      } else {
        // division ‚Äì make clean division
        b = randomInt(1, 5 + Math.floor(difficulty / 2));
        correct = randomInt(1, 10);
        a = b * correct;
      }

      const questionText = `What is ${a} ${op} ${b}?`;

      const options = new Set();
      options.add(correct);
      while (options.size < 4) {
        let delta = randomInt(-3, 3);
        if (delta === 0) delta = 1;
        const candidate = correct + delta;
        if (candidate >= 0) options.add(candidate);
      }
      const optionArray = Array.from(options).sort((x, y) => x - y);
      const correctIndex = optionArray.indexOf(correct);

      // Build hints
      const hints = [];
      if (op === "+") {
        hints.push("Hint 1: Addition means putting things together.");
        hints.push(`Hint 2: Start from ${a} and count up ${b} steps.`);
        hints.push(`Hint 3: ${a} + ${b} = ? Try counting slowly with your fingers.`);
      } else if (op === "-") {
        hints.push("Hint 1: Subtraction means taking away.");
        hints.push(`Hint 2: Imagine you have ${a} things and you give away ${b}. How many are left?`);
        hints.push(`Hint 3: ${a} ‚àí ${b} = ? Count backward from ${a}.`);
      } else if (op === "√ó") {
        hints.push("Hint 1: Multiplication is repeated addition.");
        hints.push(`Hint 2: Think of ${a} groups of ${b} or ${b} groups of ${a}.`);
        hints.push(`Hint 3: Add ${a} to itself ${b} times (or ${b} to itself ${a} times).`);
      } else {
        hints.push("Hint 1: Division shares a number into equal parts.");
        hints.push(`Hint 2: If ${a} is shared equally among ${b} people, each gets the same number.`);
        hints.push(`Hint 3: Think: ${b} √ó ? = ${a}. That ? is the answer.`);
      }

      const explanation = (() => {
        if (op === "+") {
          return `We add ${a} and ${b}: ${a} + ${b} = ${correct}.`;
        } else if (op === "-") {
          return `We subtract ${b} from ${a}: ${a} ‚àí ${b} = ${correct}.`;
        } else if (op === "√ó") {
          return `${a} √ó ${b} means adding ${a} a total of ${b} times (or ${b} a total of ${a} times). The answer is ${correct}.`;
        } else {
          return `${a} √∑ ${b} asks: how many groups of ${b} make ${a}? Since ${b} √ó ${correct} = ${a}, the answer is ${correct}.`;
        }
      })();

      return {
        question: questionText,
        options: optionArray,
        correctIndex,
        explanation,
        hints
      };
    }

    function generateNonMathQuestions(subjectId, cls, count) {
      // Simple, small conceptual pool with varied wording + repeated pattern to reach 50+
      const basePool = [];
      if (subjectId === "science") {
        basePool.push(
          {
            question: "Which of these is a living thing?",
            options: ["Rock", "Table", "Dog", "Car"],
            correctIndex: 2,
            explanation: "Living things grow, need food and can move on their own. A dog is a living thing.",
            hints: [
              "Hint 1: Living things can grow and need food.",
              "Hint 2: Think of something that can breathe.",
              "Hint 3: Among rock, table, dog and car ‚Äì which one is an animal?"
            ]
          },
          {
            question: "Water changes into water vapour on:",
            options: ["Freezing", "Boiling", "Melting", "Cutting"],
            correctIndex: 1,
            explanation: "On boiling, water gets heated and changes into water vapour (a gas).",
            hints: [
              "Hint 1: Water vapour forms when water is heated a lot.",
              "Hint 2: It happens when water starts bubbling strongly.",
              "Hint 3: Which process heats water the most ‚Äì freezing or boiling?"
            ]
          }
        );
      } else if (subjectId === "english") {
        basePool.push(
          {
            question: "Which sentence starts with a capital letter and ends with a full stop?",
            options: ["i like apples", "i Like apples.", "I like apples.", "i Like Apples"],
            correctIndex: 2,
            explanation: "A correct sentence starts with a capital letter and ends with a full stop: 'I like apples.'",
            hints: [
              "Hint 1: Look for a capital letter at the beginning.",
              "Hint 2: Look for a full stop at the end.",
              "Hint 3: Only one option has both capital 'I' and a full stop."
            ]
          },
          {
            question: "Which word is a noun?",
            options: ["Run", "Happy", "Chair", "Quickly"],
            correctIndex: 2,
            explanation: "A noun is a naming word for a person, place or thing. 'Chair' is a thing.",
            hints: [
              "Hint 1: Nouns are names of people, places or things.",
              "Hint 2: 'Run' is an action, 'happy' is a feeling.",
              "Hint 3: Think about which one is an object you can sit on."
            ]
          }
        );
      } else if (subjectId === "hindi") {
        basePool.push(
          {
            question: "‚Äò‡§∏‡•ç‡§ï‡•Ç‡§≤‚Äô ‡§ï‡§ø‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡§æ ‡§∂‡§¨‡•ç‡§¶ ‡§π‡•à?",
            options: ["‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ", "‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ", "‡§µ‡§ø‡§∂‡•á‡§∑‡§£", "‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ"],
            correctIndex: 0,
            explanation: "‚Äò‡§∏‡•ç‡§ï‡•Ç‡§≤‚Äô ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§π ‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ ‡§π‡•à‡•§",
            hints: [
              "‡§∏‡§Ç‡§ï‡•á‡§§ 1: ‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø, ‡§∏‡•ç‡§•‡§æ‡§® ‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§",
              "‡§∏‡§Ç‡§ï‡•á‡§§ 2: ‚Äò‡§∏‡•ç‡§ï‡•Ç‡§≤‚Äô ‡§è‡§ï ‡§ú‡§ó‡§π ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§¨‡§ö‡•ç‡§ö‡•á ‡§™‡§¢‡§º‡§®‡•á ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§",
              "‡§∏‡§Ç‡§ï‡•á‡§§ 3: ‡§Ø‡§π ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ‡§Æ ‡§Ø‡§æ ‡§ó‡•Å‡§£ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§Ø‡§π ‡§è‡§ï ‡§∏‡•ç‡§•‡§æ‡§® ‡§π‡•à‡•§"
            ]
          },
          {
            question: "‚Äò‡§µ‡§π ‡§¶‡•å‡§°‡§º ‡§∞‡§π‡§æ ‡§π‡•à‡•§‚Äô ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‚Äò‡§¶‡•å‡§°‡§º‚Äô ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
            options: ["‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ", "‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ", "‡§µ‡§ø‡§∂‡•á‡§∑‡§£", "‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ"],
            correctIndex: 1,
            explanation: "‚Äò‡§¶‡•å‡§°‡§º ‡§∞‡§π‡§æ ‡§π‡•à‚Äô ‡§è‡§ï ‡§ï‡§æ‡§Æ ‡§ï‡•ã ‡§¨‡§§‡§æ‡§§‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§π‡•à‡•§",
            hints: [
              "‡§∏‡§Ç‡§ï‡•á‡§§ 1: ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ‡§Æ ‡§ï‡•ã ‡§¨‡§§‡§æ‡§§‡•Ä ‡§π‡•à‡•§",
              "‡§∏‡§Ç‡§ï‡•á‡§§ 2: ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§ï‡•å‡§® ‡§∏‡§æ ‡§∂‡§¨‡•ç‡§¶ ‡§ï‡§æ‡§Æ ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à?",
              "‡§∏‡§Ç‡§ï‡•á‡§§ 3: ‚Äò‡§¶‡•å‡§°‡§º‚Äô ‡§è‡§ï ‡§ï‡§æ‡§Æ ‡§π‡•à ‡§ú‡•ã ‡§ï‡•ã‡§à ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§"
            ]
          }
        );
      }

      const questions = [];
      let idx = 0;
      while (questions.length < count) {
        const q = basePool[idx % basePool.length];
        // clone & add slight variation tag to avoid same object
        questions.push({
          question: q.question,
          options: q.options.slice(),
          correctIndex: q.correctIndex,
          explanation: q.explanation,
          hints: q.hints.slice()
        });
        idx++;
      }

      return questions;
    }

    function buildQuizBankForSelection() {
      const cls = state.selectedClass || 1; // default
      const subjectId = state.selectedSubject || "maths";
      const targetCount = 50;

      let questions = [];
      if (subjectId === "maths") {
        for (let i = 0; i < targetCount; i++) {
          questions.push(generateMathQuestion(cls));
        }
      } else {
        questions = generateNonMathQuestions(subjectId, cls, targetCount);
      }

      debugLog("Quiz bank built", { class: cls, subject: subjectId, count: questions.length });
      return questions;
    }

    function startQuiz() {
      state.quizQuestions = buildQuizBankForSelection();
      state.quizIndex = 0;
      state.quizScore = 0;
      state.quizHintsUsed = 0;
      debugLog("Quiz started", { totalQuestions: state.quizQuestions.length });

      renderQuizQuestion();
    }

    function renderQuizQuestion() {
      const quizContent = document.getElementById("quizContent");
      const quizStatus = document.getElementById("quizStatus");
      const hintsStatus = document.getElementById("quizHintsStatus");
      if (!quizContent || !quizStatus || !hintsStatus) return;

      if (state.quizIndex >= state.quizQuestions.length) {
        state.progress.quizzesTaken += 1;
        state.progress.correctAnswers += state.quizScore;
        updateProgressUI();

        quizContent.innerHTML = `
          <div class="quiz-question">
            <strong>Great job!</strong> You answered ${state.quizScore} out of ${state.quizQuestions.length} correctly.
            <button class="btn-primary" style="margin-top:6px;" id="restartQuizBtn">üîÅ Try Another Set</button>
          </div>
        `;
        quizStatus.textContent = "Quiz finished. Start again for a fresh random set.";
        hintsStatus.textContent = "Hints left: 0";
        document.getElementById("restartQuizBtn").addEventListener("click", startQuiz);
        debugLog("Quiz completed", {
          score: state.quizScore,
          total: state.quizQuestions.length
        });
        return;
      }

      const current = state.quizQuestions[state.quizIndex];
      state.quizHintsUsed = 0;
      quizStatus.textContent = `Question ${state.quizIndex + 1} of ${state.quizQuestions.length}`;
      hintsStatus.textContent = `Hints left: ${state.quizHintsPerQuestion - state.quizHintsUsed}`;

      let html = "";
      html += `<div class="quiz-question"><strong>${current.question}</strong></div>`;
      html += `<div class="quiz-options">`;
      current.options.forEach((opt, idx) => {
        const inputId = `q${state.quizIndex}_opt${idx}`;
        html += `
          <label for="${inputId}">
            <input type="radio" name="quizOption" id="${inputId}" value="${idx}" />
            ${opt}
          </label>
        `;
      });
      html += `</div>`;
      html += `
        <div class="row-between" style="margin-top:6px;">
          <button class="btn" id="showHintBtn">üí° Show Hint</button>
          <button class="btn-primary" id="nextQuestionBtn">Next</button>
        </div>
        <div id="hintContainer"></div>
        <div id="explanationContainer"></div>
      `;

      quizContent.innerHTML = html;

      const nextBtn = document.getElementById("nextQuestionBtn");
      const hintBtn = document.getElementById("showHintBtn");
      const hintContainer = document.getElementById("hintContainer");
      const explanationContainer = document.getElementById("explanationContainer");

      if (hintBtn) {
        hintBtn.addEventListener("click", () => {
          if (state.quizHintsUsed >= state.quizHintsPerQuestion) {
            alert("No hints left for this question.");
            return;
          }
          const hintIndex = state.quizHintsUsed;
          const hintText = current.hints[hintIndex] || "Think about the concept again and try slowly.";
          state.quizHintsUsed += 1;
          hintsStatus.textContent = `Hints left: ${state.quizHintsPerQuestion - state.quizHintsUsed}`;
          const div = document.createElement("div");
          div.className = "hint-box";
          div.textContent = hintText;
          hintContainer.appendChild(div);
          debugLog("Hint shown", {
            questionIndex: state.quizIndex,
            hintNumber: state.quizHintsUsed
          });
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          const selected = document.querySelector('input[name="quizOption"]:checked');
          if (!selected) {
            alert("Please choose an answer before going to next question.");
            return;
          }
          const selectedIndex = Number(selected.value);
          const correctIndex = current.correctIndex;
          const correct = selectedIndex === correctIndex;

          explanationContainer.innerHTML = `
            <div class="explanation-box">
              ${correct ? "‚úÖ Correct!" : "‚ùå Not correct."}
              ${current.explanation}
            </div>
          `;

          if (correct) {
            state.quizScore += 1;
            debugLog("Quiz question answered correctly", {
              index: state.quizIndex,
              selectedIndex,
              correctIndex
            });
          } else {
            debugLog("Quiz question answered incorrectly", {
              index: state.quizIndex,
              selectedIndex,
              correctIndex
            });
          }

          // Small delay so student can read explanation
          setTimeout(() => {
            state.quizIndex += 1;
            renderQuizQuestion();
          }, 1200);
        });
      }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    /************************************************************
     *  HUGGING FACE AI TUTOR ‚Äì FRONTEND CALL
     ************************************************************/
    async function askAi() {
      const questionEl = document.getElementById("aiQuestion");
      const statusEl = document.getElementById("aiStatus");
      const answerBox = document.getElementById("aiAnswerBox");
      const btn = document.getElementById("askAiBtn");

      if (!questionEl || !statusEl || !answerBox || !btn) {
        debugLog("AI UI elements missing");
        return;
      }

      const userQuestion = questionEl.value.trim();
      if (!userQuestion) {
        alert("Please type a question or topic for the AI to help with.");
        return;
      }

      const subjectObj = subjects.find((s) => s.id === state.selectedSubject);
      const contextClass = state.selectedClass ? "Class " + state.selectedClass : "Class unknown";
      const contextSubject = subjectObj ? subjectObj.label : "Subject unknown";

      const fullPrompt =
        `You are a helpful tutor for Indian school students.\n` +
        `Board: CBSE/State. ${contextClass}, ${contextSubject}.\n` +
        `Explain step by step in simple English (and use small examples). ` +
        `Avoid very advanced topics unless necessary.\n\n` +
        `Student question: ${userQuestion}`;

      statusEl.textContent = "Contacting AI via Hugging Face Space...";
      btn.disabled = true;
      btn.textContent = "‚è≥ Asking AI...";

      debugLog("AI request starting", {
        backend: HF_BACKEND_URL,
        class: state.selectedClass,
        subject: state.selectedSubject
      });

      try {
        const response = await fetch(HF_BACKEND_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ data: [fullPrompt] })
        });

        if (!response.ok) {
          throw new Error("HF API status " + response.status);
        }

        const result = await response.json();

        let aiText = "";
        if (Array.isArray(result.data)) {
          aiText = String(result.data[0]);
        } else if (Array.isArray(result) && result[0].generated_text) {
          aiText = result[0].generated_text;
        } else if (result.generated_text) {
          aiText = result.generated_text;
        } else {
          aiText = "AI responded, but the format was unexpected. Please adjust JSON parsing in code.";
        }

        statusEl.textContent = "AI answer received.";
        answerBox.textContent = aiText;
        state.progress.aiQueries += 1;
        updateProgressUI();

        debugLog("AI response received", {
          length: aiText.length
        });
      } catch (error) {
        console.error(error);
        statusEl.textContent =
          "There was an error connecting to the Hugging Face Space. Check HF_BACKEND_URL or network connection.";
        answerBox.textContent = error.message;
        debugLog("AI request error", { error: String(error) });
      } finally {
        btn.disabled = false;
        btn.textContent = "‚ö° Ask AI";
      }
    }

    /************************************************************
     *  VOICE INPUT (Web Speech API) FOR AI TUTOR
     ************************************************************/
    function initVoiceInput() {
      const voiceBtn = document.getElementById("voiceInputBtn");
      const questionEl = document.getElementById("aiQuestion");
      const voiceHint = document.getElementById("voiceSupportHint");

      if (!voiceBtn || !questionEl || !voiceHint) {
        debugLog("Voice UI elements missing");
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        voiceBtn.disabled = true;
        voiceBtn.title = "Voice input not supported in this browser.";
        voiceHint.textContent = "Voice input is not supported on this browser. Try using the latest Chrome or Edge on desktop/mobile.";
        debugLog("Web Speech API not supported");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = "en-IN";
      recognition.continuous = false;
      recognition.interimResults = false;

      state.voice.recognition = recognition;

      recognition.addEventListener("start", () => {
        state.voice.listening = true;
        voiceBtn.classList.add("active");
        voiceBtn.textContent = "üõë";
        voiceBtn.title = "Click to stop listening";
        voiceHint.textContent = "Listening... Speak your question clearly.";
        debugLog("Voice recognition started");
      });

      recognition.addEventListener("end", () => {
        state.voice.listening = false;
        voiceBtn.classList.remove("active");
        voiceBtn.textContent = "üé§";
        voiceBtn.title = "Click to start voice input";
        voiceHint.textContent = "";
        debugLog("Voice recognition ended");
      });

      recognition.addEventListener("error", (event) => {
        debugLog("Voice recognition error", { error: event.error });
        voiceHint.textContent = "Voice input error: " + event.error;
      });

      recognition.addEventListener("result", (event) => {
        const transcript = Array.from(event.results)
          .map((res) => res[0].transcript)
          .join(" ");
        debugLog("Voice recognition transcript", { transcript });
        const existing = questionEl.value.trim();
        questionEl.value = existing ? existing + " " + transcript : transcript;
      });

      voiceBtn.addEventListener("click", () => {
        if (!state.voice.recognition) return;
        if (state.voice.listening) {
          state.voice.recognition.stop();
        } else {
          try {
            state.voice.recognition.start();
          } catch (e) {
            debugLog("Voice recognition start error", { error: String(e) });
          }
        }
      });

      voiceHint.textContent = "Voice input is available. Click üé§ to start speaking your question.";
      debugLog("Voice input initialised");
    }

    /************************************************************
     *  PROGRESS UI
     ************************************************************/
    function updateProgressUI() {
      const qEl = document.getElementById("progressQuizzes");
      const cEl = document.getElementById("progressCorrect");
      const aiEl = document.getElementById("progressAi");
      if (qEl) qEl.textContent = "üßÆ Quizzes taken: " + state.progress.quizzesTaken;
      if (cEl) cEl.textContent = "‚úÖ Correct answers: " + state.progress.correctAnswers;
      if (aiEl) aiEl.textContent = "ü§ñ AI questions: " + state.progress.aiQueries;
    }

    /************************************************************
     *  DOM READY ‚Äì INITIALISE EVERYTHING
     ************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      debugLog("DOM fully loaded, initialising app...");

      try {
        buildClassButtons();
        buildSubjectButtons();

        const startQuizBtn = document.getElementById("startQuizBtn");
        if (startQuizBtn) {
          startQuizBtn.addEventListener("click", startQuiz);
        } else {
          debugLog("startQuizBtn not found");
        }

        const askAiBtn = document.getElementById("askAiBtn");
        if (askAiBtn) {
          askAiBtn.addEventListener("click", askAi);
        } else {
          debugLog("askAiBtn not found");
        }

        updateProgressUI();
        updateNcertSection();
        initVoiceInput();

        debugLog("App initialised successfully");
      } catch (err) {
        debugLog("App initialisation error", { error: String(err) });
      }
    });
  </script>
</body>
</html>
